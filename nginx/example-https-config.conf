#----------------------------------------------------
# HTTP â†’ HTTPS Redirect
# Ensures all traffic is encrypted
#----------------------------------------------------
server {
    listen 80;
    server_name web.sagar.com.np;

    # Permanent redirect to HTTPS preserving URI
    return 301 https://$host$request_uri;
}

#----------------------------------------------------
# HTTPS Server Block (Production Optimized)
#----------------------------------------------------
server {
    # Enable SSL and HTTP/2 for better performance
    listen 443 ssl http2;
    server_name web.sagar.com.np;

    #------------------------------------------------
    # SSL Certificate Configuration
    #------------------------------------------------
    ssl_certificate     /etc/nginx/conf.d/ssl_wildcard.sagar.com.np/wildcard.sagar.com.np.crt;
    ssl_certificate_key /etc/nginx/conf.d/ssl_wildcard.sagar.com.np/wildcard.sagar.com.np.key;

    #------------------------------------------------
    # TLS Protocol Hardening
    # Allow only secure protocol versions
    #------------------------------------------------
    ssl_protocols TLSv1.2 TLSv1.3;

    # TLS 1.3 ciphers are auto-selected by OpenSSL
    # Below list applies only to TLS 1.2
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:
                 ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

    # Let OpenSSL choose optimal cipher order (recommended)
    ssl_prefer_server_ciphers off;

    #------------------------------------------------
    # SSL Session Optimization
    # Reduces TLS handshake overhead
    #------------------------------------------------
    ssl_session_cache shared:SSL:50m;     # Shared cache across workers
    ssl_session_timeout 1d;               # Session reuse duration
    ssl_session_tickets off;              # Disable for forward secrecy

    #------------------------------------------------
    # OCSP Stapling (Disabled)
    # Enable when full chain & outbound DNS is confirmed
    #------------------------------------------------
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # resolver 1.1.1.1 8.8.8.8 valid=300s;
    # resolver_timeout 5s;

    #------------------------------------------------
    # Security Headers
    # Enforces browser-side security policies
    #------------------------------------------------
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY always;                   # Prevent clickjacking
    add_header X-Content-Type-Options nosniff always;         # Prevent MIME sniffing
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    #------------------------------------------------
    # Content Security Policy (CSP)
    # Allows HTTPS resources while restricting framing
    #------------------------------------------------
    add_header Content-Security-Policy "
        default-src 'self' https:;
        script-src 'self' https: 'unsafe-inline' 'unsafe-eval';
        style-src  'self' https: 'unsafe-inline';
        img-src    'self' data: https:;
        font-src   'self' https: data:;
        connect-src 'self' https:;
        frame-ancestors 'none';
    " always;

    #------------------------------------------------
    # Reverse Proxy Performance Tuning
    #------------------------------------------------
    proxy_http_version 1.1;        # Required for keepalive
    proxy_set_header Connection ""; # Enable upstream keepalive

    proxy_buffers 32 16k;          # Buffer tuning for large responses
    proxy_buffer_size 32k;

    proxy_connect_timeout 10s;     # Backend connect timeout
    proxy_send_timeout 60s;        # Timeout for sending request
    proxy_read_timeout 60s;        # Timeout for reading response

    #------------------------------------------------
    # Allow underscores in headers
    # Required for some applications / APIs
    #------------------------------------------------
    underscores_in_headers on;

    #------------------------------------------------
    # Forward Client Headers to Backend
    #------------------------------------------------
    proxy_set_header Host $host;                    # Preserve original host
    proxy_set_header X-Real-IP $remote_addr;        # Client IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;       # Original scheme

    #------------------------------------------------
    # Backend Application Proxy
    #------------------------------------------------
    location / {
        proxy_pass http://10.10.10:7080;            # Upstream backend service
    }
}
